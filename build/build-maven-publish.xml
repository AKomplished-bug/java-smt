<!--
This file is part of JavaSMT,
an API wrapper for a collection of SMT solvers:
https://github.com/sosy-lab/java-smt

SPDX-FileCopyrightText: 2020 Dirk Beyer <https://www.sosy-lab.org>

SPDX-License-Identifier: Apache-2.0
-->

<project name="maven" basedir="."
         xmlns:ivy="antlib:org.apache.ivy.ant"
         xmlns:artifact="antlib:org.apache.maven.artifact.ant">

    <!-- Defined maven snapshots and staging repository id and url -->
    <property name="ossrh-snapshots-repository-url"
        value="https://oss.sonatype.org/content/repositories/snapshots" />
    <property name="ossrh-staging-repository-url"
        value="file:///home/fri/workspace/maven-repo" />

    <!-- There server id in the Maven settings.xml -->
    <property name="ossrh-server-id" value="ossrh" />

    <target name="gen-pom" depends="load-ivy, determine-version" description="Generate a POM file from Ivy metadata">
        <property name="ivy.pom.version" value="${version}"/>

        <ivy:makepom ivyfile="${ivy.dep.file}" conf="core,runtime-smtinterpol,runtime-princess-with-javacup,runtime-z3" pomfile="pom.xml" templatefile="pom_template.xml">
            <mapping conf="core,runtime-smtinterpol,runtime-princess-with-javacup,runtime-z3" scope="compile"/>
        </ivy:makepom>

        <!-- Maven group is "sosy-lab", not "sosy_lab"-->
        <replace file="pom.xml">
            <replacetoken>sosy_lab</replacetoken>
            <replacevalue>sosy-lab</replacevalue>
        </replace>
    </target>

    <target name="deploy-to-maven-central" depends="dist, gen-pom, jar"
        description="deploy snapshot version to Maven snapshot repository">

        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
            <arg value="-Durl=${ossrh-snapshots-repository-url}" />
            <arg value="-DrepositoryId=${ossrh-server-id}" />
            <arg value="-DpomFile=pom.xml" />
            <arg value="-Dfile=${jar.file}" />
        </artifact:mvn>
    </target>

    <!-- before this, update project version (both build.xml and pom.xml) from SNAPSHOT to RELEASE -->
    <target name="stage" depends="dist, gen-pom, jar, sources" description="deploy release version to Maven staging repository">

        <!-- Sign and deploy the main artifact. -->
        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
            <arg value="-Durl=${ossrh-staging-repository-url}" />
            <arg value="-DrepositoryId=${ossrh-server-id}" />
            <arg value="-DpomFile=pom.xml" />
            <arg value="-Dfile=${jar.file}" />
            <arg value="-Pgpg" />
        </artifact:mvn>

        <!-- Sign and deploy the sources artifact -->
        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
            <arg value="-Durl=${ossrh-staging-repository-url}" />
            <arg value="-DrepositoryId=${ossrh-server-id}" />
            <arg value="-DpomFile=pom.xml" />
            <arg value="-Dfile=${ivy.module}-${version}-sources.jar" />
            <arg value="-Dclassifier=sources" />
            <arg value="-Pgpg" />
        </artifact:mvn>

        <!-- sign and deploy the javadoc artifact -->
        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
            <arg value="-Durl=${ossrh-staging-repository-url}" />
            <arg value="-DrepositoryId=${ossrh-server-id}" />
            <arg value="-DpomFile=pom.xml" />
            <arg value="-Dfile=${ivy.module}-${version}-javadoc.jar" />
            <arg value="-Dclassifier=javadoc" />
            <arg value="-Pgpg" />
        </artifact:mvn>
    </target>


    <!--
        Next section: publish files for Z3 into Maven.
        We use the z3-jar-file as central modul and define all native libraries as (direct/flat)
        dependencies. Thus, only the z3-jar-file requires a pom-file and we can use default values
        (without the need of a pom-file) for the native libraries.
    -->
    <target name="gen-pom-z3" depends="load-ivy" description="Generate a POM file for Z3 from Ivy metadata">
        <property name="ivy.pom.version" value="${version}"/>

        <ivy:makepom ivyfile="solvers_ivy_conf/ivy_z3.xml" conf="solver-z3" pomfile="pom_z3.xml" templatefile="solvers_ivy_conf/pom_template_z3.xml">
            <mapping conf="solver-z3" scope="compile"/>
        </ivy:makepom>

        <!-- Maven group is "sosy-lab", not "sosy_lab"-->
        <replace file="pom_z3.xml">
            <replacetoken>sosy_lab</replacetoken>
            <replacevalue>sosy-lab</replacevalue>
        </replace>
    </target>

    <target name="stage-z3" depends="gen-pom-z3" description="deploy Z3 (including its native libraries) to Maven staging repository">

        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
            <arg value="-Durl=${ossrh-staging-repository-url}" />
            <arg value="-DrepositoryId=${ossrh-server-id}" />
            <arg value="-DpomFile=pom_z3.xml" />
            <arg value="-Dfile=lib/java/runtime-z3/com.microsoft.z3.jar" />
            <arg value="-Pgpg" />
        </artifact:mvn>

        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
            <arg value="-Durl=${ossrh-staging-repository-url}" />
            <arg value="-DrepositoryId=${ossrh-server-id}" />
            <arg value="-Dfile=lib/java/runtime-z3/libz3.so" />
            <arg value="-DgroupId=org.sosy-lab" />
            <arg value="-DartifactId=javasmt-solver-z3-libz3" />
            <arg value="-Dversion=4.8.8" />
            <arg value="-Dpackaging=so" />
            <arg value="-Pgpg" />
        </artifact:mvn>

        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
            <arg value="-Durl=${ossrh-staging-repository-url}" />
            <arg value="-DrepositoryId=${ossrh-server-id}" />
            <arg value="-Dfile=lib/java/runtime-z3/libz3java.so" />
            <arg value="-DgroupId=org.sosy-lab" />
            <arg value="-DartifactId=javasmt-solver-z3-libz3java" />
            <arg value="-Dversion=4.8.8" />
            <arg value="-Dpackaging=so" />
            <arg value="-Pgpg" />
        </artifact:mvn>
<!--
mvn org.apache.maven.plugins:maven-deploy-plugin:3.0.0-M1:deploy-file \
    -Durl=file:///home/fri/workspace/maven-repo -DrepositoryId=fri \
    -Dfile=lib/java/runtime-z3/com.microsoft.z3.jar -DgroupId=org.sosy-lab \
    -DartifactId=javasmt-solver-z3 -Dversion=4.8.8 -Dpackaging=jar
-->
    </target>

</project>
